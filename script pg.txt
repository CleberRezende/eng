CREATE TABLE Seguranca.Usuario(
  cpf		VARCHAR(20) CONSTRAINT unq__USUARIO_CPF UNIQUE CONSTRAINT nn_USUARIO_CPF NOT NULL,
  senha   VARCHAR(100) CONSTRAINT nn_USUARIO_SENHA NOT NULL,
  email	VARCHAR(100) CONSTRAINT nn_USUARIO_EMAIL NOT NULL
);

CREATE SCHEMA Seguranca;

SET SEARCH_PATH = Seguranca;

CREATE OR REPLACE FUNCTION Seguranca.inserirUsuario(pCpf   VARCHAR(20),
                                                    pSenha VARCHAR(100),
                                                    pEmail VARCHAR(100))
  RETURNS JSON AS $$

DECLARE
  vRetException VARCHAR(1000);
  vReturnId     VARCHAR(20);

BEGIN

  INSERT INTO Seguranca.Usuario(
    CPF,
    SENHA,
    EMAIL
  )VALUES(
    pCpf,
    MD5(pSenha),
    pEmail) RETURNING cpf INTO vReturnId;

  RETURN '{"result": "Usuario cadastrado com sucesso!", "CPF":"' || vReturnId || '", "code":0}';

  EXCEPTION WHEN OTHERS
  THEN
    GET STACKED DIAGNOSTICS vRetException = MESSAGE_TEXT;
    RETURN '{"result": ' || to_json(vRetException) || ', "code": 500}';
END;
$$
LANGUAGE plpgsql;

SELECT * FROM Seguranca.inserirUsuario('087.831.666-89', '123321', 'wagner@engsolutions.com.br');







-----------------------------------------------------------------------------------------------------






CREATE TABLE Seguranca.Usuario(
  cpf		VARCHAR(20) CONSTRAINT unq__USUARIO_CPF UNIQUE CONSTRAINT nn_USUARIO_CPF NOT NULL,
  senha   VARCHAR(100) CONSTRAINT nn_USUARIO_SENHA NOT NULL,
  email	VARCHAR(100) CONSTRAINT nn_USUARIO_EMAIL NOT NULL
);

CREATE SCHEMA Seguranca;

SET SEARCH_PATH = Seguranca;

CREATE OR REPLACE FUNCTION Seguranca.inserirUsuario(pCpf   VARCHAR(20),
                                                    pSenha VARCHAR(100),
                                                    pEmail VARCHAR(100))
  RETURNS JSON AS $$

DECLARE
  vRetException VARCHAR(1000);
  vReturnId     VARCHAR(20);

BEGIN

  INSERT INTO Seguranca.Usuario(
    CPF,
    SENHA,
    EMAIL
  )VALUES(
    pCpf,
    MD5(pSenha),
    pEmail) RETURNING cpf INTO vReturnId;

  RETURN '{"result": "Usuario cadastrado com sucesso!", "CPF":"' || vReturnId || '", "code":0}';

  EXCEPTION WHEN OTHERS
  THEN
    GET STACKED DIAGNOSTICS vRetException = MESSAGE_TEXT;
    RETURN '{"result": ' || to_json(vRetException) || ', "code": 500}';
END;
$$
LANGUAGE plpgsql;

SELECT * FROM Seguranca.inserirUsuario('087.831.666-89', '123321', 'wagner@engsolutions.com.br');